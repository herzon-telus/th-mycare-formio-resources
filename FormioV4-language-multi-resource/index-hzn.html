<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Form.io Existing Form POC</title>
    <!-- Form.io CSS -->
    <link rel="stylesheet" href="https://cdn.form.io/formiojs/formio.full.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- Form.io JavaScript -->
    <script src="https://cdn.form.io/formiojs/formio.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.form.io/js/formio.form.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"/>

</head>
<body>
    <div id="formio"></div>

<script>
    // URLs del formulario y resources de idioma
    const formUrl = 'https://form-io.preprod.babylonbytelushealth.com/qiedzdtecdtedeu/hznweightmanagmentsprint42';

    const languageResourceGlobal = 'https://form-io.preprod.babylonbytelushealth.com/qiedzdtecdtedeu/language';
    const languageResourceLocal  = 'https://form-io.preprod.babylonbytelushealth.com/qiedzdtecdtedeu/languageformweightmanagement';

    var languages = {};

    // --- Utilidad para mergear objetos (override del local sobre el global) ---
    function deepMerge(target, source) {
        for (let key in source) {
            if (
                source[key] &&
                typeof source[key] === 'object' &&
                !Array.isArray(source[key])
            ) {
                if (!target[key]) target[key] = {};
                deepMerge(target[key], source[key]);
            } else {
                target[key] = source[key]; // override
            }
        }
        return target;
    }

    // --- Función para obtener las traducciones desde un resource ---
    function fetchTranslations(resourceUrl, lang) {
        return Formio.fetch(resourceUrl + '/submission?data.language=' + lang)
            .then(resp => resp.json())
            .then(result => {
                if (!result || !result.length) return {};
                return result[0].data.translations || {};
            })
            .catch(err => {
                console.error("Error loading from resource:", resourceUrl, err);
                return {};
            });
    }

    // --- Nueva función setLanguage con dos resources ---
    function setLanguage(lang) {

        Promise.all([
            fetchTranslations(languageResourceGlobal, lang),
            fetchTranslations(languageResourceLocal, lang)
        ])
        .then(([globalTranslations, localTranslations]) => {

            // Merge: local overridea global
            const merged = deepMerge(globalTranslations, localTranslations);

            languages[lang] = merged;

            if (window.form) {
                form.addLanguage(lang, merged);
                form.language = lang;
                form.redraw();
            }
        });
    }

    // Crear el formulario
    Formio.createForm(document.getElementById('formio'), formUrl)
    .then(function(formInstance) {
        window.form = formInstance;
        setLanguage('en');
    });
</script>

</body>
</html>
