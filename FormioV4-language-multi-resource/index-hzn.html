<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Form.io Existing Form POC</title>
    <!-- Form.io CSS -->
    <link rel="stylesheet" href="https://cdn.form.io/formiojs/formio.full.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- Form.io JavaScript -->
    <script src="https://cdn.form.io/formiojs/formio.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.form.io/js/formio.form.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"/>

</head>
<body>
    <div id="formio"></div>

<script>
    const formUrl = 'https://form-io.preprod.babylonbytelushealth.com/qiedzdtecdtedeu/hznweightmanagmentsprint42';
    const baseUrl = 'https://form-io.preprod.babylonbytelushealth.com/qiedzdtecdtedeu/';

    var languages = {};
    var languageResourceGlobal = null;
    var languageResourceLocal  = null;

    // --- Utility for merging objects ---
    function deepMerge(target, source) {
        for (let key in source) {
            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                if (!target[key]) target[key] = {};
                deepMerge(target[key], source[key]);
            } else {
                target[key] = source[key];
            }
        }
        return target;
    }

    // --- Load a language resource ---
    function fetchTranslations(resourceUrl, lang) {
        return Formio.fetch(resourceUrl + '/submission?data.language=' + lang)
            .then(resp => resp.json())
            .then(result => {
                if (!result || !result.length) return {};
                return result[0].data.translations || {};
            })
            .catch(err => {
                console.error("Error loading from resource:", resourceUrl, err);
                return {};
            });
    }

    // --- setLanguage using dynamic resources ---
    function setLanguage(lang) {
        // If we only have global resource, just fetch that one
        if (!languageResourceLocal) {
            fetchTranslations(languageResourceGlobal, lang)
                .then(translations => {
                    languages[lang] = translations;

                    if (window.form) {
                        form.addLanguage(lang, translations);
                        form.language = lang;
                        form.redraw();
                    }
                });
            return;
        }

        // If we have both resources, fetch both and merge them
        Promise.all([
            fetchTranslations(languageResourceGlobal, lang),
            fetchTranslations(languageResourceLocal, lang)
        ])
        .then(([globalTranslations, localTranslations]) => {
            const merged = deepMerge(globalTranslations, localTranslations);

            languages[lang] = merged;

            if (window.form) {
                form.addLanguage(lang, merged);
                form.language = lang;
                form.redraw();
            }
        });
    }

    // --- Create form ---
    Formio.createForm(document.getElementById('formio'), formUrl)
    .then(function(formInstance) {

        // Get form tags
        fetch(formUrl)
            .then(response => response.json())
            .then(data => {
                const tags = data.tags || [];
                console.log("Tags found:", JSON.stringify(tags));

                if (tags.length === 0) {
                    console.error("No tags found in the form");
                    return;
                }

                // Dynamic construction of resources using tags
                if (tags.length === 1) {
                    // If there's only one tag, use it as global resource
                    languageResourceGlobal = baseUrl + tags[0];
                    languageResourceLocal = null;
                    console.log("Only one resource found (global):", languageResourceGlobal);
                } else {
                    // If there are two or more tags, use the first as global and the second as local
                    languageResourceGlobal = baseUrl + tags[0];
                    languageResourceLocal = baseUrl + tags[1];
                    console.log("Global Resource:", languageResourceGlobal);
                    console.log("Local Resource:", languageResourceLocal);
                }

                // Set initial language
                setLanguage('en');
            })
            .catch(error => console.error('Error fetching form data:', error));

        window.form = formInstance;
    });
</script>


</body>
</html>
